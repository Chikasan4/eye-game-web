<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>動体視力トレ V4</title>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #202020;
            font-family: sans-serif; color: white; touch-action: none;
        }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between;
        }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; }

        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        h1 { margin-bottom: 20px; font-size: 28px; text-align: center; color: #00FF7F; }
        
        .btn {
            width: 80%; max-width: 300px; padding: 15px; margin: 10px;
            font-size: 18px; font-weight: bold; color: white;
            background-color: #444; border: 2px solid #00FF7F;
            border-radius: 10px; cursor: pointer; text-align: center;
        }
        .btn:active { transform: scale(0.95); background-color: #555; }
        
        #result-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); flex-direction: column;
            align-items: center; justify-content: center; z-index: 50;
        }
        #result-msg { font-size: 32px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>動体視力トレ<br>Mobile V4</h1>
        <div class="btn" onclick="startGame('random')">① ランダム (反射)</div>
        <div class="btn" onclick="startGame('figure8')">② 8の字 (追従)</div>
        <div class="btn" onclick="startGame('depth')">③ 遠近 (距離感)</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-layer">
            <div class="hud">Score: <span id="scoreVal">0</span></div>
            <div class="hud">Time: <span id="timeVal">30</span></div>
        </div>
    </div>

    <div id="result-screen">
        <div id="result-msg">Time Up!</div>
        <div class="btn" onclick="backToMenu()">メニューに戻る</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const scoreEl = document.getElementById('scoreVal');
        const timeEl = document.getElementById('timeVal');

        let width, height;
        let score = 0;
        let timeLeft = 30;
        let gameActive = false;
        let targets = [];
        let gameLoopId;
        let timerId;
        let currentMode = 'random';
        let frameCount = 0;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        function startGame(mode) {
            currentMode = mode;
            menuScreen.style.display = 'none';
            resultScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            
            score = 0;
            timeLeft = 30;
            frameCount = 0;
            scoreEl.innerText = score;
            timeEl.innerText = timeLeft;
            gameActive = true;
            
            targets = [];
            // 初期スポーン
            if (currentMode === 'figure8') {
                targets.push({ x: width/2, y: height/2, r: 30, color: '#00FF7F' });
            } else {
                spawnTarget(); // random と depth はここで生成
            }

            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            update();
        }

        function backToMenu() {
            resultScreen.style.display = 'none';
            gameContainer.style.display = 'none';
            menuScreen.style.display = 'flex';
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerId);
            cancelAnimationFrame(gameLoopId);
            document.getElementById('result-msg').innerHTML = `Time Up!<br>Score: ${score}`;
            resultScreen.style.display = 'flex';
        }

        function spawnTarget() {
            // モードによって動きの質を変える
            const r = 30; // 基準サイズ
            const x = Math.random() * (width - r * 2) + r;
            const y = Math.random() * (height - r * 2) + r;
            const speed = 4;
            
            targets.push({
                x: x, y: y, r: r, baseR: r, // baseRは基準サイズ
                vx: (Math.random() - 0.5) * speed * 2,
                vy: (Math.random() - 0.5) * speed * 2,
                color: '#00FF7F',
                depthPhase: Math.random() * Math.PI * 2 // 遠近のタイミングをずらす
            });
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, width, height);
            frameCount++;

            // ■■■ 8の字モード ■■■
            if (currentMode === 'figure8') {
                const t = targets[0];
                const centerX = width / 2;
                const centerY = height / 2;
                const radiusX = width * 0.35; 
                const radiusY = height * 0.2; 
                const speed = 0.05;
                t.x = centerX + Math.cos(frameCount * speed) * radiusX;
                t.y = centerY + Math.sin(frameCount * speed * 2) * radiusY;
            }
            // ■■■ ランダム & 遠近モード ■■■
            else {
                targets.forEach(t => {
                    t.x += t.vx;
                    t.y += t.vy;
                    if (t.x - t.r < 0 || t.x + t.r > width) t.vx *= -1;
                    if (t.y - t.r < 0 || t.y + t.r > height) t.vy *= -1;

                    // ★ V4追加：遠近（サイズ変化）処理
                    if (currentMode === 'depth') {
                        // サイン波で大きさを変える（0.5倍 〜 1.5倍）
                        const scale = 1 + 0.5 * Math.sin(frameCount * 0.05 + t.depthPhase);
                        t.r = t.baseR * scale;
                    }
                });
            }

            // 描画
            targets.forEach(t => {
                ctx.beginPath();
                ctx.arc(t.x, t.y, t.r, 0, Math.PI * 2);
                ctx.fillStyle = t.color;
                ctx.fill();
                ctx.closePath();
            });

            gameLoopId = requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive) return;
            e.preventDefault();
            const touches = e.changedTouches || [e]; 
            
            for (let i = 0; i < touches.length; i++) {
                const tx = touches[i].clientX;
                const ty = touches[i].clientY;

                for (let j = targets.length - 1; j >= 0; j--) {
                    const t = targets[j];
                    const dist = Math.hypot(t.x - tx, t.y - ty);
                    
                    // 判定（見た目の大きさに合わせる）
                    if (dist < t.r + 20) { 
                        score++;
                        scoreEl.innerText = score;

                        if (currentMode === 'random' || currentMode === 'depth') {
                            targets.splice(j, 1);
                            spawnTarget();
                            // 5点ごとにターゲット追加
                            if (score % 5 === 0) spawnTarget();
                        }
                        break;
                    }
                }
            }
        }

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput, {passive: false});

    </script>
</body>
</html>