<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Vision V51</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯V50ã‚’ç¶™æ‰¿ã—ã€ä¸€éƒ¨æœ€é©åŒ– */
        body { margin: 0; overflow: hidden; background-color: #8B4513; font-family: sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; }
        #combo-display { color: #FFD700; font-size: 24px; font-weight:900; text-align: center; width: 100%; position: absolute; top: 90px; opacity: 0; transition: opacity 0.1s; text-shadow: 0 0 10px orange; }
        #diff-display { position: absolute; bottom: 20px; right: 20px; font-size: 14px; color: #aaa; text-align: right; }
        #diff-val { font-size: 20px; font-weight: bold; color: white; }
        #dynamic-rule { position: absolute; top: 10%; left: 50%; transform: translate(-50%, 0); font-size: 28px; font-weight: 900; color: white; pointer-events: none; white-space: nowrap; z-index: 6; text-shadow: 2px 2px 0 #000; background-color: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; display: none; }
        #action-guide { position: absolute; top: 20%; left: 50%; transform: translate(-50%, 0); font-size: 20px; font-weight: bold; color: rgba(255,255,255,0.7); pointer-events: none; white-space: pre-line; z-index: 5; text-align: center; line-height: 1.4; text-shadow: 1px 1px 2px black; }
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 100; overflow-y: auto; padding-top: 20px; padding-bottom: 40px; }
        h1 { margin: 10px 0 10px 0; font-size: 22px; text-align: center; color: #00FF7F; border-bottom: 2px solid #00FF7F; padding-bottom: 5px; }
        .section-title { color: #ddd; font-size: 13px; margin-top: 15px; margin-bottom: 5px; width: 90%; max-width: 350px; text-align: left; border-left: 3px solid #00FF7F; padding-left: 8px; }
        .btn { width: 90%; max-width: 350px; padding: 14px; margin: 6px 0; font-size: 16px; font-weight: bold; color: white; background-color: #333; border: 1px solid #555; border-radius: 6px; cursor: pointer; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .btn:active { transform: scale(0.98); background-color: #444; }
        .btn-vision { background-color: #2F4F4F; border-color: #00FA9A; color: #00FA9A; }
        .btn-measure { background-color: #8B0000; border-color: #FF6347; color: white; }
        .btn-def { background-color: #191970; border-color: #4169E1; }
        .btn-off { background-color: #8B4500; border-color: #FFA500; }
        .btn-rally { background-color: #4B0082; border-color: #9370DB; }
        #feedback-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; font-weight: 900; opacity: 0; pointer-events: none; transition: opacity 0.1s; text-shadow: 2px 2px 0 #000; z-index: 20; white-space: nowrap; }
        #result-screen, #report-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 150; }
        #result-main { font-size: 50px; font-weight: 900; color: #00FF7F; margin-bottom: 15px; text-align: center; white-space: pre-line;}
        table { border-collapse: collapse; width: 95%; max-width: 400px; color: white; margin-bottom: 20px; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background-color: #222; color: #00FF7F; }
        .rank-ss { color: #FF00FF; font-weight: 900; text-shadow: 0 0 5px #FF00FF; }
        .rank-s { color: #FFD700; font-weight: 900; text-shadow: 0 0 5px #FFD700; }
        .rank-a { color: #00FF7F; font-weight: bold; }
        #reflex-signal { display: none; position: absolute; top: 50%; left: 50%; width: 200px; height: 200px; border-radius: 50%; transform: translate(-50%, -50%); background-color: #333; border: 4px solid #555; z-index: 10; cursor: pointer; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: white; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>Badminton Vision V51<br><span style="font-size:12px; color:#aaa;">DYNAMIC JUDGMENT</span></h1>
        <div class="btn btn-report" onclick="showReport()">ğŸ“Š ç·åˆãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div class="section-title">ã€Aã€‘åŸºç¤ãƒ»çœ¼çƒãƒˆãƒ¬</div>
        <div class="btn btn-vision" onclick="startGame('saccade')">â‘  è·³èºæ€§ (å¾ŒåŠ: åˆ¤æ–­ãƒ¢ãƒ¼ãƒ‰)</div>
        <div class="btn btn-vision" onclick="startGame('pursuit')">â‘¡ è¿½å¾“æ€§ (TRACE)</div>
        <div class="btn btn-vision" onclick="startGame('depth')">â‘¢ æ·±è¦–åŠ› (RANDOM)</div>
        <div class="section-title">ã€Bã€‘æ¸¬å®š</div>
        <div class="btn btn-measure" onclick="startGame('reflex')">â‘£ åå°„ç¥çµŒ (AGE TEST)</div>
        <div class="section-title">ã€Cã€‘å®Ÿæˆ¦ (åˆ¤æ–­æ‰“ã¡åˆ†ã‘)</div>
        <div class="btn btn-def" onclick="startGame('defense')">â‘¤ å®ˆã‚Š (TAP)</div>
        <div class="btn btn-off" onclick="startGame('offense')">â‘¥ æ”»ã‚ (SWIPE)</div>
        <div class="btn btn-rally" onclick="startGame('rally')">â‘¦ ç·åˆ (Mix)</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="feedback-msg"></div>
        <div id="dynamic-rule">TARGET: ğŸŸ©</div>
        <div id="action-guide"></div>
        <div id="reflex-signal">WAIT</div>
        <div id="combo-display">0 COMBO</div>
        <div id="diff-display">SPEED: <span id="diff-val">LV.1</span></div>
        <div id="ui-layer">
            <div class="hud" id="hud-left">Score: 0</div>
            <div class="hud" id="hud-right">Time: 30</div>
        </div>
    </div>

    <div id="result-screen">
        <div id="result-title">RESULT</div>
        <div id="result-main">0</div>
        <div id="result-sub">...</div>
        <button id="close-result-btn" class="btn" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <div id="report-screen">
        <h2 style="color:#00FF7F;">TOTAL REPORT</h2>
        <table id="report-table"></table>
        <div class="btn" onclick="closeReport()">é–‰ã˜ã‚‹</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const reportScreen = document.getElementById('report-screen');
        const hudLeft = document.getElementById('hud-left');
        const hudRight = document.getElementById('hud-right');
        const feedbackEl = document.getElementById('feedback-msg');
        const dynamicRuleEl = document.getElementById('dynamic-rule');
        const comboEl = document.getElementById('combo-display');
        const diffValEl = document.getElementById('diff-val');
        const reflexSignal = document.getElementById('reflex-signal');
        const closeResultBtn = document.getElementById('close-result-btn');

        let width, height, gameMode, score, combo, timeLeft, gameActive;
        let targets = [], effects = [], spawnTimer = 0, animationFrameId, gameTimerId;
        let currentDifficulty = 0.0;
        let saccadeTargetColor = 'green', saccadePhase = 1;
        let lastScores = {}, bestScores = JSON.parse(localStorage.getItem('bv_bestScores')) || {};
        let isTouching = false, startX = 0, startY = 0, currentX = 0, currentY = 0;

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize);
        resize();

        function updateSaccadeRule() {
            if(saccadeTargetColor === 'green') {
                dynamicRuleEl.innerText = "TARGET: ğŸŸ© GREEN";
                dynamicRuleEl.style.color = "#00FF7F";
                dynamicRuleEl.style.border = "2px solid #00FF7F";
            } else {
                dynamicRuleEl.innerText = "TARGET: ğŸŸ¥ RED";
                dynamicRuleEl.style.color = "#FF4500";
                dynamicRuleEl.style.border = "2px solid #FF4500";
            }
        }

        function startGame(mode) {
            gameMode = mode;
            menuScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            resultScreen.style.display = 'none';
            score = 0; combo = 0; targets = []; effects = []; gameActive = true;
            currentDifficulty = 0.0;
            timeLeft = (mode === 'rally') ? 60 : 30;
            
            if(mode === 'saccade') {
                saccadePhase = 1; saccadeTargetColor = 'green';
                dynamicRuleEl.style.display = 'block';
                updateSaccadeRule();
            } else {
                dynamicRuleEl.style.display = 'none';
            }
            
            hudLeft.innerText = "Score: 0";
            hudRight.innerText = `Time: ${timeLeft}`;
            startTimer();
            update();
        }

        function startTimer() {
            clearInterval(gameTimerId);
            gameTimerId = setInterval(() => {
                timeLeft--;
                hudRight.innerText = `Time: ${timeLeft}`;
                if (gameMode === 'saccade' && timeLeft === 20) {
                    saccadePhase = 2;
                    showFeedback("JUDGMENT MODE!", "yellow");
                }
                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function spawnTarget() {
            // V51: è·³èºæ€§ã§ã¯å¸¸ã«ç”»é¢ã«1ã¤ã ã‘ã«ã™ã‚‹
            if (gameMode === 'saccade' && targets.length > 0) return;

            const d = currentDifficulty;
            if (gameMode === 'saccade') {
                const r = 35;
                let life = 75 - (d * 45);
                if (saccadePhase === 2) {
                    life = life * 0.65; // å¾ŒåŠã¯ã•ã‚‰ã«é«˜é€ŸåŒ–
                    // å‡ºç¾ã”ã¨ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè‰²ã¨ãƒ«ãƒ¼ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–
                    saccadeTargetColor = Math.random() < 0.5 ? 'green' : 'red';
                    updateSaccadeRule();
                }

                // è‰²ã®ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®šï¼ˆå¾ŒåŠã®ã¿ï¼‰
                let targetType = 'green_ball';
                let color = '#00FF7F';
                if (saccadePhase === 2) {
                    if(Math.random() < 0.5) {
                        targetType = 'red_ball';
                        color = '#FF4500';
                    }
                }

                targets.push({
                    x: Math.random()*(width-2*r)+r,
                    y: Math.random()*(height*0.7 - height*0.2) + height*0.2,
                    r: r, color: color, type: targetType, 
                    life: life, maxLife: life, isHit: false
                });
            } 
            // ... ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã¯V50ã¨åŒæ§˜ã®ãŸã‚çœç•¥ï¼ˆå¿…è¦ã«å¿œã˜ã¦çµ±åˆï¼‰
        }

        function update() {
            if (!gameActive) return;
            ctx.fillStyle = "#8B4513";
            ctx.fillRect(0,0,width,height);

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã„ãªã„æ™‚ã€ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”ã§ç”Ÿæˆ
            if (targets.length === 0) {
                spawnTimer--;
                if (spawnTimer <= 0) {
                    spawnTarget();
                    // ä¸€å®šå‘¨æœŸã‚’é¿ã‘ã‚‹ãŸã‚ã®ãƒ©ãƒ³ãƒ€ãƒ ãªéŠã³ (0.1ã€œ0.4ç§’ç¨‹åº¦)
                    spawnTimer = 5 + Math.random() * 20; 
                }
            }

            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                t.life--;
                if (t.life <= 0) {
                    // æ­£è§£è‰²ã‚’è¦‹é€ƒã—ãŸå ´åˆã¯ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
                    let isCorrectColor = (saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball');
                    if (isCorrectColor && gameMode === 'saccade') adjustDifficulty(false);
                    targets.splice(i, 1);
                    continue;
                }
                let alpha = t.life / t.maxLife;
                drawCircle(t.x, t.y, t.r, t.color, alpha);
            }
            updateEffects(); drawEffects();
            animationFrameId = requestAnimationFrame(update);
        }

        function checkHit(tx, ty) {
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                if (Math.hypot(t.x - tx, t.y - ty) < t.r + 25) {
                    let isCorrect = true;
                    if (gameMode === 'saccade' && saccadePhase === 2) {
                        isCorrect = (saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball');
                    }

                    if (isCorrect) {
                        score += Math.floor(30 * (1 + currentDifficulty * 2));
                        hudLeft.innerText = `Score: ${score}`;
                        showFeedback("HIT!", "cyan");
                        spawnEffect(t.x, t.y);
                        adjustDifficulty(true);
                    } else {
                        // ä¸æ­£è§£æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£
                        timeLeft = Math.max(0, timeLeft - 3);
                        hudRight.innerText = `Time: ${timeLeft}`;
                        showFeedback("-3 SEC!", "red");
                        adjustDifficulty(false);
                    }
                    targets.splice(i, 1);
                    break;
                }
            }
        }

        function adjustDifficulty(success) {
            if (success) { combo++; currentDifficulty = Math.min(1.0, currentDifficulty + 0.05); }
            else { combo = 0; currentDifficulty = Math.max(0.0, currentDifficulty - 0.1); }
            updateDiffDisplay();
        }

        function updateDiffDisplay() {
            let lv = Math.floor(currentDifficulty * 10) + 1;
            diffValEl.innerText = currentDifficulty >= 1.0 ? "MAX" : `LV.${lv}`;
        }

        function drawCircle(x, y, r, color, alpha) {
            ctx.globalAlpha = alpha; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
            ctx.fillStyle = color; ctx.fill(); ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke(); ctx.globalAlpha = 1.0;
        }

        function showFeedback(text, color) {
            feedbackEl.innerText = text; feedbackEl.style.color = color; feedbackEl.style.opacity = 1;
            setTimeout(() => feedbackEl.style.opacity = 0, 400);
        }

        function updateEffects() { for(let i=effects.length-1; i>=0; i--) { effects[i].life--; effects[i].r+=5; if(effects[i].life<=0) effects.splice(i,1); } }
        function drawEffects() { for(let e of effects) { ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.strokeStyle = `rgba(255,255,255,${e.life/10})`; ctx.stroke(); } }
        function spawnEffect(x,y) { effects.push({x:x, y:y, life:10, r:10}); }

        function finishGame() { gameActive = false; clearInterval(gameTimerId); cancelAnimationFrame(animationFrameId); resultScreen.style.display = 'flex'; document.getElementById('result-main').innerText = score; }
        function backToMenu() { gameActive = false; menuScreen.style.display = 'flex'; gameContainer.style.display = 'none'; resultScreen.style.display = 'none'; }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); checkHit(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        canvas.addEventListener('mousedown', (e) => { checkHit(e.clientX, e.clientY); });
    </script>
</body>
</html>