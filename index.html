<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Vision V54</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #8B4513; font-family: sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; }
        #combo-display { color: #FFD700; font-size: 24px; font-weight:900; text-align: center; width: 100%; position: absolute; top: 90px; opacity: 0; text-shadow: 0 0 10px orange; }
        #diff-display { position: absolute; bottom: 20px; right: 20px; font-size: 14px; color: #aaa; text-align: right; }
        #diff-val { font-size: 20px; font-weight: bold; color: white; }
        #dynamic-rule { position: absolute; top: 10%; left: 50%; transform: translate(-50%, 0); font-size: 28px; font-weight: 900; color: white; pointer-events: none; z-index: 6; text-shadow: 2px 2px 0 #000; background-color: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; display: none; border: 3px solid transparent; }
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; z-index: 100; overflow-y: auto; padding-top: 20px; padding-bottom: 40px; }
        h1 { font-size: 22px; color: #00FF7F; border-bottom: 2px solid #00FF7F; }
        .btn { width: 90%; max-width: 350px; padding: 14px; margin: 6px 0; font-size: 16px; font-weight: bold; color: white; background-color: #333; border: 1px solid #555; border-radius: 6px; cursor: pointer; text-align: center; }
        .btn-vision { background-color: #2F4F4F; border-color: #00FA9A; color: #00FA9A; }
        #feedback-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; font-weight: 900; opacity: 0; text-shadow: 2px 2px 0 #000; z-index: 20; }
        #result-screen, #report-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 150; }
        #result-main { font-size: 50px; font-weight: 900; color: #00FF7F; }
        table { border-collapse: collapse; width: 95%; max-width: 400px; color: white; margin-bottom: 20px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>Badminton Vision V54</h1>
        <div class="btn" onclick="showReport()">ğŸ“Š ç·åˆãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div class="section-title">ã€Aã€‘åŸºç¤ãƒ»çœ¼çƒãƒˆãƒ¬</div>
        <div class="btn btn-vision" onclick="startGame('saccade')">â‘  è·³èºæ€§ (SSé«˜è² è·ãƒ»å®Œæˆç‰ˆ)</div>
        <div class="btn btn-vision" onclick="startGame('pursuit')">â‘¡ è¿½å¾“æ€§</div>
        <div class="btn btn-vision" onclick="startGame('depth')">â‘¢ æ·±è¦–åŠ›</div>
        <div class="section-title">ã€Bã€‘æ¸¬å®š</div>
        <div class="btn" style="background:#8B0000" onclick="startGame('reflex')">â‘£ åå°„ç¥çµŒ</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="feedback-msg"></div>
        <div id="dynamic-rule">TARGET: ğŸŸ©</div>
        <div id="combo-display">0 COMBO</div>
        <div id="diff-display">SPEED: <span id="diff-val">LV.1</span></div>
        <div id="ui-layer">
            <div class="hud" id="hud-left">Score: 0</div>
            <div class="hud" id="hud-right">Time: 30</div>
        </div>
    </div>

    <div id="result-screen">
        <div style="color:#aaa">RESULT</div>
        <div id="result-main">0</div>
        <div id="result-sub" style="margin-bottom:20px">CLASS: -</div>
        <button class="btn" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <div id="report-screen">
        <h2 style="color:#00FF7F;">TOTAL REPORT</h2>
        <table id="report-table"></table>
        <div class="btn" onclick="closeReport()">é–‰ã˜ã‚‹</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const reportScreen = document.getElementById('report-screen');
        const hudLeft = document.getElementById('hud-left');
        const hudRight = document.getElementById('hud-right');
        const feedbackEl = document.getElementById('feedback-msg');
        const dynamicRuleEl = document.getElementById('dynamic-rule');
        const comboEl = document.getElementById('combo-display');
        const diffValEl = document.getElementById('diff-val');

        let width, height, gameMode, score, combo, timeLeft, gameActive;
        let targets = [], effects = [], spawnTimer = 0, animationFrameId, gameTimerId;
        let currentDifficulty = 0.0, saccadeTargetColor = 'green', saccadePhase = 1;
        let bestScores = JSON.parse(localStorage.getItem('bv_bestScores')) || {saccade:0, pursuit:0, depth:0, reflex:null};

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize); resize();

        function getRankInfo(val) {
            if (val >= 2500) return { rank: "SS", title: "Legend" };
            if (val >= 2000) return { rank: "S", title: "Top Athlete" };
            if (val >= 1500) return { rank: "A", title: "Athlete" };
            if (val >= 800) return { rank: "B", title: "General" };
            return { rank: "C", title: "Beginner" };
        }

        function startGame(mode) {
            gameMode = mode; score = 0; combo = 0; targets = []; gameActive = true; currentDifficulty = 0.0;
            menuScreen.style.display = 'none'; gameContainer.style.display = 'block'; resultScreen.style.display = 'none';
            timeLeft = 30; saccadePhase = 1; saccadeTargetColor = 'green';
            if(mode === 'saccade') { dynamicRuleEl.style.display = 'block'; updateSaccadeRule(); }
            startTimer(); update();
        }

        function startTimer() {
            clearInterval(gameTimerId);
            gameTimerId = setInterval(() => {
                timeLeft--; hudRight.innerText = `Time: ${timeLeft}`;
                if (timeLeft === 20) { saccadePhase = 2; showFeedback("JUDGMENT!", "yellow"); }
                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateSaccadeRule() {
            dynamicRuleEl.innerText = `TARGET: ${saccadeTargetColor === 'green' ? 'ğŸŸ© GREEN' : 'ğŸŸ¥ RED'}`;
            dynamicRuleEl.style.color = saccadeTargetColor === 'green' ? "#00FF7F" : "#FF4500";
            dynamicRuleEl.style.borderColor = saccadeTargetColor === 'green' ? "#00FF7F" : "#FF4500";
        }

        function spawnTarget() {
            if (targets.length > 0) return; // 1å€‹é™å®š
            const r = 35;
            let d = currentDifficulty;
            if (gameMode === 'saccade') {
                let life = 70 - (d * 50);
                if (saccadePhase === 2) { 
                    life *= 0.6; // é«˜é€ŸåŒ–
                    saccadeTargetColor = Math.random() < 0.5 ? 'green' : 'red';
                    updateSaccadeRule();
                }
                // å‡ºç¾ã™ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è‰²ã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®š
                let targetType = Math.random() < 0.5 && saccadePhase === 2 ? 'red' : 'green';
                targets.push({
                    x: Math.random()*(width-2*r)+r, y: Math.random()*(height*0.6)+height*0.2,
                    r: r, color: targetType === 'red' ? '#FF4500' : '#00FF7F', type: targetType,
                    life: life, maxLife: life
                });
            } else if (gameMode === 'pursuit') {
                targets.push({ x: width/2, y: height/2, r: 35, color: 'cyan', type: 'moving', angle: 0, speed: 0.03 + d*0.05 });
            } else if (gameMode === 'depth') {
                targets.push({ x: Math.random()*(width-100)+50, y: Math.random()*(height-100)+50, r: 5, color: 'yellow', type: 'zoom', growing: true, maxR: 110, zSpeed: 5 + d*8 });
            }
        }

        function update() {
            if (!gameActive) return;
            ctx.fillStyle = "#8B4513"; ctx.fillRect(0,0,width,height);
            if (targets.length === 0) { spawnTimer--; if (spawnTimer <= 0) { spawnTarget(); spawnTimer = 4 + Math.random()*12; } }
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i]; t.life--;
                if (t.life <= 0) {
                    if (gameMode === 'saccade') {
                        if (t.type === saccadeTargetColor) { combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.1); }
                    }
                    targets.splice(i, 1); continue;
                }
                if (t.type === 'moving') { t.angle += t.speed; t.x = width/2 + Math.cos(t.angle*1.5)*(width*0.4); t.y = height/2 + Math.sin(t.angle*2.3)*(height*0.25); }
                if (t.type === 'zoom') { if(t.growing) { t.r += t.zSpeed; if(t.r >= t.maxR) t.growing = false; } else { t.r -= t.zSpeed; if(t.r <= 0) { targets.splice(i,1); continue; } } }
                ctx.globalAlpha = t.life/t.maxLife;
                ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
                ctx.fillStyle = (t.type === 'zoom' && t.r > t.maxR*0.8) ? 'yellow' : t.color;
                ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke(); ctx.globalAlpha = 1;
            }
            updateEffects(); drawEffects();
            animationFrameId = requestAnimationFrame(update);
        }

        function checkHit(tx, ty) {
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                if (Math.hypot(t.x - tx, t.y - ty) < t.r + 30) {
                    let hit = true;
                    if (gameMode === 'saccade') {
                        if (t.type !== saccadeTargetColor) {
                            hit = false; timeLeft = Math.max(0, timeLeft - 4); showFeedback("-4 SEC!", "red");
                            combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.2);
                        }
                    }
                    if (hit) {
                        combo++; 
                        // SSèª¿æ•´: åŸºç¤ç‚¹80 + é›£æ˜“åº¦ãƒœãƒ¼ãƒŠã‚¹ + ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹
                        let pts = (80 + (combo * 2)) * (1 + currentDifficulty * 2.5);
                        score += Math.floor(pts);
                        hudLeft.innerText = `Score: ${score}`; showFeedback("HIT!", "cyan");
                        spawnEffect(t.x, t.y); currentDifficulty = Math.min(1.0, currentDifficulty + 0.08);
                        targets.splice(i, 1);
                        comboEl.innerText = `${combo} COMBO`; comboEl.style.opacity = 1; setTimeout(()=>comboEl.style.opacity=0, 500);
                    }
                    break;
                }
            }
            let lv = Math.floor(currentDifficulty * 10) + 1;
            diffValEl.innerText = currentDifficulty >= 1.0 ? "MAX" : `LV.${lv}`;
        }

        function showFeedback(text, color) { feedbackEl.innerText = text; feedbackEl.style.color = color; feedbackEl.style.opacity = 1; setTimeout(()=>feedbackEl.style.opacity=0, 400); }
        function spawnEffect(x,y) { effects.push({x:x, y:y, life:10, r:10}); }
        function updateEffects() { for(let i=effects.length-1; i>=0; i--) { effects[i].life--; effects[i].r+=5; if(effects[i].life<=0) effects.splice(i,1); } }
        function drawEffects() { for(let e of effects) { ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.strokeStyle = `rgba(255,255,255,${e.life/10})`; ctx.stroke(); } }

        function finishGame() {
            gameActive = false; clearInterval(gameTimerId); cancelAnimationFrame(animationFrameId);
            bestScores[gameMode] = Math.max(bestScores[gameMode] || 0, score);
            localStorage.setItem('bv_bestScores', JSON.stringify(bestScores));
            const info = getRankInfo(score);
            document.getElementById('result-main').innerText = score;
            document.getElementById('result-sub').innerText = `CLASS: ${info.rank} (${info.title})`;
            resultScreen.style.display = 'flex';
        }

        function backToMenu() { resultScreen.style.display = 'none'; gameContainer.style.display = 'none'; menuScreen.style.display = 'flex'; }
        function showReport() {
            menuScreen.style.display = 'none'; reportScreen.style.display = 'flex';
            let html = "<tr><th>é …ç›®</th><th>Best</th></tr>";
            Object.keys(bestScores).forEach(k => {
                const info = getRankInfo(bestScores[k]);
                html += `<tr><td>${k}</td><td>${bestScores[k]} (${info.rank})</td></tr>`;
            });
            document.getElementById('report-table').innerHTML = html;
        }
        function closeReport() { reportScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

        canvas.addEventListener('mousedown', (e) => checkHit(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); checkHit(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
    </script>
</body>
</html>