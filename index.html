<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Vision V52</title>
    <style>
        /* V51„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÁ∂ôÊâø */
        body { margin: 0; overflow: hidden; background-color: #8B4513; font-family: sans-serif; color: white; touch-action: none; user-select: none; }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; }
        #combo-display { color: #FFD700; font-size: 24px; font-weight:900; text-align: center; width: 100%; position: absolute; top: 90px; opacity: 0; text-shadow: 0 0 10px orange; }
        #dynamic-rule { position: absolute; top: 10%; left: 50%; transform: translate(-50%, 0); font-size: 28px; font-weight: 900; color: white; background-color: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; display: none; text-shadow: 2px 2px 0 #000; }
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 100; overflow-y: auto; }
        h1 { font-size: 22px; color: #00FF7F; border-bottom: 2px solid #00FF7F; }
        .btn { width: 90%; max-width: 350px; padding: 14px; margin: 6px 0; font-size: 16px; font-weight: bold; color: white; background-color: #333; border: 1px solid #555; border-radius: 6px; cursor: pointer; text-align: center; }
        .btn-vision { background-color: #2F4F4F; border-color: #00FA9A; }
        #feedback-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; font-weight: 900; opacity: 0; transition: opacity 0.1s; text-shadow: 2px 2px 0 #000; z-index: 20; }
        #result-screen, #report-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 150; }
        #result-main { font-size: 50px; font-weight: 900; color: #00FF7F; text-align: center; }
        table { border-collapse: collapse; width: 95%; max-width: 400px; color: white; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        .rank-ss { color: #FF00FF; font-weight: 900; text-shadow: 0 0 5px #FF00FF; }
        .rank-s { color: #FFD700; font-weight: 900; }
        .rank-a { color: #00FF7F; }
    </style>
</head>
<body>
    <div id="menu-screen">
        <h1>Badminton Vision V52</h1>
        <div class="btn" onclick="showReport()">üìä Á∑èÂêà„É¨„Éù„Éº„Éà</div>
        <div class="btn btn-vision" onclick="startGame('saccade')">‚ë† Ë∑≥Ë∫çÊÄß (SSË™øÊï¥Áâà)</div>
        </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="feedback-msg"></div>
        <div id="dynamic-rule">TARGET: üü©</div>
        <div id="combo-display">0 COMBO</div>
        <div id="ui-layer">
            <div class="hud" id="hud-left">Score: 0</div>
            <div class="hud" id="hud-right">Time: 30</div>
        </div>
    </div>

    <div id="result-screen">
        <div style="color:#aaa">RESULT</div>
        <div id="result-main">0</div>
        <div id="result-sub" style="margin-bottom:20px">CLASS: -</div>
        <button class="btn" onclick="backToMenu()">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
    </div>

    <div id="report-screen">
        <h2 style="color:#00FF7F;">TOTAL REPORT</h2>
        <table id="report-table"></table>
        <div class="btn" onclick="closeReport()">Èñâ„Åò„Çã</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const reportScreen = document.getElementById('report-screen');
        const hudLeft = document.getElementById('hud-left');
        const hudRight = document.getElementById('hud-right');
        const feedbackEl = document.getElementById('feedback-msg');
        const dynamicRuleEl = document.getElementById('dynamic-rule');
        const comboEl = document.getElementById('combo-display');

        let width, height, gameMode, score, combo, timeLeft, gameActive;
        let targets = [], effects = [], spawnTimer = 0, animationFrameId, gameTimerId;
        let currentDifficulty = 0.0, saccadeTargetColor = 'green', saccadePhase = 1;
        let lastScores = {}, bestScores = JSON.parse(localStorage.getItem('bv_bestScores')) || {saccade:0, pursuit:0, depth:0, reflex:null, defense:0, offense:0, rally:0};

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize); resize();

        function getRankInfo(mode, val) {
            if (!val) return { rank: "C", title: "Beginner" };
            if (val >= 2500) return { rank: "SS", title: "Legend" };
            if (val >= 2000) return { rank: "S", title: "Top Athlete" };
            if (val >= 1500) return { rank: "A", title: "Athlete" };
            if (val >= 800) return { rank: "B", title: "General" };
            return { rank: "C", title: "Beginner" };
        }

        function startGame(mode) {
            gameMode = mode; score = 0; combo = 0; targets = []; gameActive = true; currentDifficulty = 0.0;
            timeLeft = 30; saccadePhase = 1; saccadeTargetColor = 'green';
            menuScreen.style.display = 'none'; gameContainer.style.display = 'block'; resultScreen.style.display = 'none';
            if(mode === 'saccade') { dynamicRuleEl.style.display = 'block'; updateSaccadeRule(); }
            startTimer(); update();
        }

        function startTimer() {
            clearInterval(gameTimerId);
            gameTimerId = setInterval(() => {
                timeLeft--; hudRight.innerText = `Time: ${timeLeft}`;
                if (timeLeft === 20) { saccadePhase = 2; showFeedback("JUDGMENT!", "yellow"); }
                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateSaccadeRule() {
            dynamicRuleEl.innerText = `TARGET: ${saccadeTargetColor === 'green' ? 'üü© GREEN' : 'üü• RED'}`;
            dynamicRuleEl.style.color = saccadeTargetColor === 'green' ? "#00FF7F" : "#FF4500";
        }

        function spawnTarget() {
            if (targets.length > 0) return;
            const r = 35;
            let life = 70 - (currentDifficulty * 50);
            if (saccadePhase === 2) { 
                life *= 0.6; 
                saccadeTargetColor = Math.random() < 0.5 ? 'green' : 'red';
                updateSaccadeRule();
            }
            let isRed = Math.random() < 0.5 && saccadePhase === 2;
            targets.push({
                x: Math.random()*(width-2*r)+r, y: Math.random()*(height*0.6)+height*0.2,
                r: r, color: isRed ? '#FF4500' : '#00FF7F', type: isRed ? 'red_ball' : 'green_ball',
                life: life, maxLife: life
            });
        }

        function update() {
            if (!gameActive) return;
            ctx.fillStyle = "#8B4513"; ctx.fillRect(0,0,width,height);
            if (targets.length === 0) { spawnTimer--; if (spawnTimer <= 0) { spawnTarget(); spawnTimer = 5 + Math.random()*15; } }
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i]; t.life--;
                if (t.life <= 0) { 
                    if ((saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball')) {
                        combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.1); 
                    }
                    targets.splice(i, 1); continue; 
                }
                ctx.globalAlpha = t.life / t.maxLife;
                ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
                ctx.fillStyle = t.color; ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke(); ctx.globalAlpha = 1;
            }
            animationFrameId = requestAnimationFrame(update);
        }

        function checkHit(tx, ty) {
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                if (Math.hypot(t.x - tx, t.y - ty) < t.r + 30) {
                    let isCorrect = (saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball');
                    if (isCorrect) {
                        combo++;
                        let bonus = 1 + (currentDifficulty * 2) + (combo * 0.05); // SSÁî®„Çπ„Ç≥„Ç¢Âº∑Âåñ
                        score += Math.floor(50 * bonus);
                        hudLeft.innerText = `Score: ${score}`;
                        showFeedback("HIT!", "cyan");
                        currentDifficulty = Math.min(1.0, currentDifficulty + 0.06);
                    } else {
                        timeLeft = Math.max(0, timeLeft - 3); showFeedback("-3 SEC!", "red");
                        combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.15);
                    }
                    targets.splice(i, 1); break;
                }
            }
        }

        function finishGame() {
            gameActive = false; clearInterval(gameTimerId); cancelAnimationFrame(animationFrameId);
            bestScores.saccade = Math.max(bestScores.saccade || 0, score);
            localStorage.setItem('bv_bestScores', JSON.stringify(bestScores));
            const info = getRankInfo('saccade', score);
            document.getElementById('result-main').innerText = score;
            document.getElementById('result-sub').innerText = `CLASS: ${info.rank} (${info.title})`;
            resultScreen.style.display = 'flex';
        }

        function backToMenu() { resultScreen.style.display = 'none'; gameContainer.style.display = 'none'; menuScreen.style.display = 'flex'; }
        function showFeedback(text, color) { feedbackEl.innerText = text; feedbackEl.style.color = color; feedbackEl.style.opacity = 1; setTimeout(()=>feedbackEl.style.opacity=0, 400); }
        
        canvas.addEventListener('mousedown', (e) => checkHit(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); checkHit(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});

        function showReport() {
            menuScreen.style.display = 'none'; reportScreen.style.display = 'flex';
            const table = document.getElementById('report-table');
            const info = getRankInfo('saccade', bestScores.saccade);
            table.innerHTML = `<tr><th>È†ÖÁõÆ</th><th>Best</th></tr><tr><td>‚ë† Ë∑≥Ë∫çÊÄß</td><td>${bestScores.saccade}<br><span class="rank-${info.rank.toLowerCase()}">${info.rank}</span></td></tr>`;
        }
        function closeReport() { reportScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }
    </script>
</body>
</html>