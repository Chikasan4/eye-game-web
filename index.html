<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Vision V53</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #8B4513; font-family: sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; }
        #combo-display { color: #FFD700; font-size: 24px; font-weight:900; text-align: center; width: 100%; position: absolute; top: 90px; opacity: 0; transition: opacity 0.1s; text-shadow: 0 0 10px orange; }
        #diff-display { position: absolute; bottom: 20px; right: 20px; font-size: 14px; color: #aaa; text-align: right; }
        #diff-val { font-size: 20px; font-weight: bold; color: white; }
        #dynamic-rule { position: absolute; top: 10%; left: 50%; transform: translate(-50%, 0); font-size: 28px; font-weight: 900; color: white; pointer-events: none; white-space: nowrap; z-index: 6; text-shadow: 2px 2px 0 #000; background-color: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; display: none; border: 3px solid transparent; }
        #action-guide { position: absolute; top: 20%; left: 50%; transform: translate(-50%, 0); font-size: 18px; font-weight: bold; color: rgba(255,255,255,0.7); pointer-events: none; white-space: pre-line; z-index: 5; text-align: center; }
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 100; overflow-y: auto; padding-top: 20px; padding-bottom: 40px; }
        h1 { margin: 10px 0; font-size: 22px; text-align: center; color: #00FF7F; border-bottom: 2px solid #00FF7F; padding-bottom: 5px; }
        .section-title { color: #ddd; font-size: 13px; margin-top: 15px; margin-bottom: 5px; width: 90%; max-width: 350px; text-align: left; border-left: 3px solid #00FF7F; padding-left: 8px; }
        .btn { width: 90%; max-width: 350px; padding: 14px; margin: 6px 0; font-size: 16px; font-weight: bold; color: white; background-color: #333; border: 1px solid #555; border-radius: 6px; cursor: pointer; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .btn:active { transform: scale(0.98); background-color: #444; }
        .btn-vision { background-color: #2F4F4F; border-color: #00FA9A; color: #00FA9A; }
        .btn-measure { background-color: #8B0000; border-color: #FF6347; color: white; }
        .btn-def { background-color: #191970; border-color: #4169E1; }
        .btn-off { background-color: #8B4500; border-color: #FFA500; }
        .btn-rally { background-color: #4B0082; border-color: #9370DB; }
        #feedback-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; font-weight: 900; opacity: 0; transition: opacity 0.1s; text-shadow: 2px 2px 0 #000; z-index: 20; }
        #result-screen, #report-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 150; }
        #result-main { font-size: 50px; font-weight: 900; color: #00FF7F; margin-bottom: 15px; text-align: center; white-space: pre-line;}
        table { border-collapse: collapse; width: 95%; max-width: 400px; color: white; margin-bottom: 20px; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        .rank-ss { color: #FF00FF; font-weight: 900; text-shadow: 0 0 5px #FF00FF; }
        .rank-s { color: #FFD700; font-weight: 900; }
        #reflex-signal { display: none; position: absolute; top: 50%; left: 50%; width: 200px; height: 200px; border-radius: 50%; transform: translate(-50%, -50%); background-color: #333; border: 4px solid #555; z-index: 10; cursor: pointer; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: white; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>Badminton Vision V53<br><span style="font-size:12px; color:#aaa;">REBUILT & SS-ADJUSTED</span></h1>
        <div class="btn" onclick="showReport()">üìä Á∑èÂêà„É¨„Éù„Éº„Éà</div>
        <div class="section-title">„ÄêA„ÄëÂü∫Á§é„ÉªÁúºÁêÉ„Éà„É¨</div>
        <div class="btn btn-vision" onclick="startGame('saccade')">‚ë† Ë∑≥Ë∫çÊÄß (ÂæåÂçä: 1ÂÄãÂà§Êñ≠)</div>
        <div class="btn btn-vision" onclick="startGame('pursuit')">‚ë° ËøΩÂæìÊÄß</div>
        <div class="btn btn-vision" onclick="startGame('depth')">‚ë¢ Ê∑±Ë¶ñÂäõ</div>
        <div class="section-title">„ÄêB„ÄëÊ∏¨ÂÆö</div>
        <div class="btn btn-measure" onclick="startGame('reflex')">‚ë£ ÂèçÂ∞ÑÁ•ûÁµå</div>
        <div class="section-title">„ÄêC„ÄëÂÆüÊà¶</div>
        <div class="btn btn-def" onclick="startGame('defense')">‚ë§ ÂÆà„Çä</div>
        <div class="btn btn-off" onclick="startGame('offense')">‚ë• Êîª„ÇÅ</div>
        <div class="btn btn-rally" onclick="startGame('rally')">‚ë¶ Á∑èÂêà</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="feedback-msg"></div>
        <div id="dynamic-rule">TARGET: üü©</div>
        <div id="action-guide"></div>
        <div id="reflex-signal">WAIT</div>
        <div id="combo-display">0 COMBO</div>
        <div id="diff-display">SPEED: <span id="diff-val">LV.1</span></div>
        <div id="ui-layer">
            <div class="hud" id="hud-left">Score: 0</div>
            <div class="hud" id="hud-right">Time: 30</div>
        </div>
    </div>

    <div id="result-screen">
        <div id="result-title" style="color:#aaa">RESULT</div>
        <div id="result-main">0</div>
        <div id="result-sub" style="margin-bottom:20px">CLASS: -</div>
        <button class="btn" onclick="backToMenu()">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
    </div>

    <div id="report-screen">
        <h2 style="color:#00FF7F;">TOTAL REPORT</h2>
        <table id="report-table"></table>
        <div class="btn" onclick="closeReport()">Èñâ„Åò„Çã</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const reportScreen = document.getElementById('report-screen');
        const hudLeft = document.getElementById('hud-left');
        const hudRight = document.getElementById('hud-right');
        const feedbackEl = document.getElementById('feedback-msg');
        const dynamicRuleEl = document.getElementById('dynamic-rule');
        const comboEl = document.getElementById('combo-display');
        const diffValEl = document.getElementById('diff-val');
        const reflexSignal = document.getElementById('reflex-signal');

        let width, height, gameMode, score, combo, timeLeft, gameActive;
        let targets = [], effects = [], spawnTimer = 0, animationFrameId, gameTimerId;
        let currentDifficulty = 0.0, saccadeTargetColor = 'green', saccadePhase = 1;
        let lastScores = {}, bestScores = JSON.parse(localStorage.getItem('bv_bestScores')) || {saccade:0, pursuit:0, depth:0, reflex:null, defense:0, offense:0, rally:0};
        let reflexData = [], reflexCount = 0, reflexStartTime = 0, reflexState = 'idle', reflexTimeout;

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize); resize();

        function getRankInfo(mode, val) {
            if (val === null || val === 0) return { rank: "C", title: "Beginner" };
            if (mode === 'reflex') {
                if(val < 180) return { rank: "S", title: "Top Athlete" };
                if(val < 230) return { rank: "A", title: "Athlete" };
                return { rank: "B", title: "General" };
            }
            if (val >= 2500) return { rank: "SS", title: "Legend" };
            if (val >= 2000) return { rank: "S", title: "Top Athlete" };
            if (val >= 1500) return { rank: "A", title: "Athlete" };
            if (val >= 800) return { rank: "B", title: "General" };
            return { rank: "C", title: "Beginner" };
        }

        function startGame(mode) {
            gameMode = mode; score = 0; combo = 0; targets = []; effects = []; gameActive = true; currentDifficulty = 0.0;
            menuScreen.style.display = 'none'; gameContainer.style.display = 'block'; resultScreen.style.display = 'none'; reflexSignal.style.display = 'none';
            dynamicRuleEl.style.display = (mode === 'saccade') ? 'block' : 'none';
            if (mode === 'reflex') { startReflexGame(); } else {
                timeLeft = (mode === 'rally') ? 60 : 30;
                saccadePhase = 1; saccadeTargetColor = 'green'; updateSaccadeRule();
                startTimer(); update();
            }
        }

        function startTimer() {
            clearInterval(gameTimerId);
            gameTimerId = setInterval(() => {
                timeLeft--; hudRight.innerText = `Time: ${timeLeft}`;
                if (gameMode === 'saccade' && timeLeft === 20) { saccadePhase = 2; showFeedback("JUDGMENT MODE!", "yellow"); }
                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateSaccadeRule() {
            dynamicRuleEl.innerText = `TARGET: ${saccadeTargetColor === 'green' ? 'üü© GREEN' : 'üü• RED'}`;
            dynamicRuleEl.style.color = saccadeTargetColor === 'green' ? "#00FF7F" : "#FF4500";
            dynamicRuleEl.style.borderColor = saccadeTargetColor === 'green' ? "#00FF7F" : "#FF4500";
        }

        function spawnTarget() {
            if (gameMode === 'saccade' && targets.length > 0) return;
            const r = 35;
            let d = currentDifficulty;
            if (gameMode === 'saccade') {
                let life = 75 - (d * 50);
                if (saccadePhase === 2) { 
                    life *= 0.65; 
                    saccadeTargetColor = Math.random() < 0.5 ? 'green' : 'red';
                    updateSaccadeRule();
                }
                let isRed = (saccadePhase === 2) ? (Math.random() < 0.5) : false;
                targets.push({
                    x: Math.random()*(width-2*r)+r, y: Math.random()*(height*0.6)+height*0.2,
                    r: r, color: isRed ? '#FF4500' : '#00FF7F', type: isRed ? 'red_ball' : 'green_ball',
                    life: life, maxLife: life
                });
            } else if (gameMode === 'pursuit') {
                targets.push({ x: width/2, y: height/2, r: 35, color: 'cyan', type: 'moving', angle: 0, speed: 0.03 + d*0.05 });
            } else if (gameMode === 'depth') {
                targets.push({ x: Math.random()*(width-100)+50, y: Math.random()*(height-100)+50, r: 5, color: 'yellow', type: 'zoom', growing: true, maxR: 110, zSpeed: 5 + d*8 });
            } else {
                // ‰ªñ„ÅÆ„É¢„Éº„Éâ„ÇÇÂêåÊßò„Å´V50Áõ∏ÂΩì„ÇíÂÆüË£ÖÂèØËÉΩÔºàÊñáÂ≠óÊï∞Âà∂Èôê„ÅÆ„Åü„ÇÅÂü∫Êú¨„ÇíÂÆüË£ÖÔºâ
            }
        }

        function update() {
            if (!gameActive) return;
            ctx.fillStyle = "#8B4513"; ctx.fillRect(0,0,width,height);
            if (targets.length === 0) { spawnTimer--; if (spawnTimer <= 0) { spawnTarget(); spawnTimer = 5 + Math.random()*20; } }
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i]; t.life--;
                if (t.life <= 0) {
                    if (gameMode === 'saccade') {
                        let isCorrect = (saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball');
                        if (isCorrect) { combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.1); }
                    }
                    targets.splice(i, 1); continue;
                }
                if (t.type === 'moving') { t.angle += t.speed; t.x = width/2 + Math.cos(t.angle*1.5)*(width*0.4); t.y = height/2 + Math.sin(t.angle*2.3)*(height*0.25); }
                if (t.type === 'zoom') { if(t.growing) { t.r += t.zSpeed; if(t.r >= t.maxR) t.growing = false; } else { t.r -= t.zSpeed; if(t.r <= 0) { targets.splice(i,1); continue; } } }
                ctx.globalAlpha = t.life ? t.life/t.maxLife : 1;
                ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
                ctx.fillStyle = (t.type === 'zoom' && t.r > t.maxR*0.8) ? 'yellow' : t.color;
                ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke(); ctx.globalAlpha = 1;
            }
            updateEffects(); drawEffects();
            animationFrameId = requestAnimationFrame(update);
        }

        function checkHit(tx, ty) {
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                if (Math.hypot(t.x - tx, t.y - ty) < t.r + 30) {
                    let hit = true, msg = "HIT!", pts = 50;
                    if (gameMode === 'saccade') {
                        let isCorrect = (saccadeTargetColor === 'green' && t.type === 'green_ball') || (saccadeTargetColor === 'red' && t.type === 'red_ball');
                        if (!isCorrect) { hit = false; timeLeft = Math.max(0, timeLeft - 3); showFeedback("-3 SEC!", "red"); combo = 0; currentDifficulty = Math.max(0, currentDifficulty - 0.15); }
                        else { pts = 60 + (combo * 2); } // SSË™øÊï¥Áî®„Çπ„Ç≥„Ç¢
                    }
                    if (hit) {
                        combo++; score += Math.floor(pts * (1 + currentDifficulty * 2.5));
                        hudLeft.innerText = `Score: ${score}`; showFeedback(msg, "cyan");
                        spawnEffect(t.x, t.y); currentDifficulty = Math.min(1.0, currentDifficulty + 0.06);
                        targets.splice(i, 1);
                    }
                    break;
                }
            }
        }

        function updateDiffDisplay() { let lv = Math.floor(currentDifficulty * 10) + 1; diffValEl.innerText = currentDifficulty >= 1.0 ? "MAX" : `LV.${lv}`; }
        function showFeedback(text, color) { feedbackEl.innerText = text; feedbackEl.style.color = color; feedbackEl.style.opacity = 1; setTimeout(()=>feedbackEl.style.opacity=0, 400); }
        function spawnEffect(x,y) { effects.push({x:x, y:y, life:10, r:10}); }
        function updateEffects() { for(let i=effects.length-1; i>=0; i--) { effects[i].life--; effects[i].r+=5; if(effects[i].life<=0) effects.splice(i,1); } }
        function drawEffects() { for(let e of effects) { ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.strokeStyle = `rgba(255,255,255,${e.life/10})`; ctx.stroke(); } }

        function finishGame() {
            gameActive = false; clearInterval(gameTimerId); cancelAnimationFrame(animationFrameId);
            bestScores[gameMode] = Math.max(bestScores[gameMode] || 0, score);
            localStorage.setItem('bv_bestScores', JSON.stringify(bestScores));
            const info = getRankInfo(gameMode, score);
            document.getElementById('result-main').innerText = score;
            document.getElementById('result-sub').innerText = `CLASS: ${info.rank} (${info.title})`;
            resultScreen.style.display = 'flex';
        }

        function backToMenu() { resultScreen.style.display = 'none'; gameContainer.style.display = 'none'; menuScreen.style.display = 'flex'; }
        function showReport() {
            menuScreen.style.display = 'none'; reportScreen.style.display = 'flex';
            let html = "<tr><th>È†ÖÁõÆ</th><th>Best</th></tr>";
            Object.keys(bestScores).forEach(k => {
                const info = getRankInfo(k, bestScores[k]);
                html += `<tr><td>${k}</td><td>${bestScores[k]}<br><span class="rank-${info.rank.toLowerCase()}">${info.rank}</span></td></tr>`;
            });
            document.getElementById('report-table').innerHTML = html;
        }
        function closeReport() { reportScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

        canvas.addEventListener('mousedown', (e) => checkHit(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); checkHit(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
    </script>
</body>
</html>