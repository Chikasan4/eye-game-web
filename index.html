<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>動体視力トレーニング Mobile</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #202020; /* 目に優しいダークグレー */
            font-family: sans-serif;
            color: white;
            touch-action: none; /* スマホでのダブルタップ拡大などを防止 */
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* UIの下のキャンバスをクリックできるようにする */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        .hud {
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 10;
        }
        h1 { margin-bottom: 20px; font-size: 24px; text-align: center;}
        button {
            padding: 15px 40px;
            font-size: 20px;
            background-color: #00FF7F; /* Target Color */
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud">Score: <span id="scoreVal">0</span></div>
        <div class="hud" style="text-align: right;">Time: <span id="timeVal">30</span></div>
    </div>

    <div id="start-screen">
        <h1>動体視力<br>トレーニング V1</h1>
        <p>緑のボールをタップせよ！</p>
        <button id="startBtn">START</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('startBtn');
        const scoreEl = document.getElementById('scoreVal');
        const timeEl = document.getElementById('timeVal');

        let width, height;
        let score = 0;
        let timeLeft = 30;
        let gameActive = false;
        let targets = [];
        let gameLoopId;
        let timerId;

        // 設定：ボールのスペック
        const TARGET_RADIUS = 25; // スマホで押しやすいサイズ
        const TARGET_COLOR = '#00FF7F'; // SpringGreen
        const BASE_SPEED = 4; 

        // 画面サイズ調整
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        class Target {
            constructor() {
                this.x = Math.random() * (width - TARGET_RADIUS * 2) + TARGET_RADIUS;
                this.y = Math.random() * (height - TARGET_RADIUS * 2) + TARGET_RADIUS;
                this.vx = (Math.random() - 0.5) * BASE_SPEED * 2;
                this.vy = (Math.random() - 0.5) * BASE_SPEED * 2;
                this.radius = TARGET_RADIUS;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                // 壁の跳ね返り
                if (this.x - this.radius < 0 || this.x + this.radius > width) this.vx *= -1;
                if (this.y - this.radius < 0 || this.y + this.radius > height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = TARGET_COLOR;
                ctx.fill();
                ctx.closePath();
            }

            isClicked(x, y) {
                const dist = Math.hypot(this.x - x, this.y - y);
                return dist < this.radius + 10; // 少し判定を甘くして押しやすく
            }
        }

        function startGame() {
            score = 0;
            timeLeft = 30;
            scoreEl.innerText = score;
            timeEl.innerText = timeLeft;
            gameActive = true;
            targets = [new Target()]; // 最初は1個
            startScreen.style.display = 'none';
            
            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            update();
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerId);
            cancelAnimationFrame(gameLoopId);
            startScreen.style.display = 'flex';
            document.querySelector('#start-screen h1').innerHTML = `Time Up!<br>Score: ${score}`;
            startBtn.innerText = "RETRY";
        }

        function update() {
            if (!gameActive) return;

            ctx.clearRect(0, 0, width, height);

            targets.forEach(t => {
                t.update();
                t.draw();
            });

            gameLoopId = requestAnimationFrame(update);
        }

        function handleInput(x, y) {
            if (!gameActive) return;
            
            // 逆順でチェック（重なっているときは手前を優先）
            for (let i = targets.length - 1; i >= 0; i--) {
                if (targets[i].isClicked(x, y)) {
                    score++;
                    scoreEl.innerText = score;
                    // クリックしたら場所を変えて再出現（反射神経トレ）
                    targets[i] = new Target(); 
                    
                    // 5点ごとにボールが増える（難易度アップ）
                    if (score % 5 === 0) {
                        targets.push(new Target());
                    }
                    break; 
                }
            }
        }

        // マウスとタッチの両対応
        window.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
        window.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            handleInput(touch.clientX, touch.clientY);
        }, {passive: false});

        startBtn.addEventListener('click', startGame);

    </script>
</body>
</html>