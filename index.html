<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>動体視力トレ V3</title>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #202020;
            font-family: sans-serif; color: white; touch-action: none;
        }
        #game-container { display: none; width: 100%; height: 100%; }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between;
        }
        .hud { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* メニュー画面 */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        h1 { margin-bottom: 30px; font-size: 28px; text-align: center; color: #00FF7F; }
        
        .btn {
            width: 80%; max-width: 300px; padding: 15px; margin: 10px;
            font-size: 18px; font-weight: bold; color: white;
            background-color: #444; border: 2px solid #00FF7F;
            border-radius: 10px; cursor: pointer; text-align: center;
        }
        .btn:active { transform: scale(0.95); background-color: #555; }
        
        /* 終了画面 */
        #result-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); flex-direction: column;
            align-items: center; justify-content: center; z-index: 50;
        }
        #result-msg { font-size: 32px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>動体視力トレ<br>Mobile V3</h1>
        <div class="btn" onclick="startGame('random')">① ランダム (反射)</div>
        <div class="btn" onclick="startGame('figure8')">② 8の字 (追従)</div>
        <div class="btn" onclick="alert('V4で実装予定です！')">③ 遠近 (Coming Soon)</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-layer">
            <div class="hud">Score: <span id="scoreVal">0</span></div>
            <div class="hud">Time: <span id="timeVal">30</span></div>
        </div>
    </div>

    <div id="result-screen">
        <div id="result-msg">Time Up!</div>
        <div class="btn" onclick="backToMenu()">メニューに戻る</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const scoreEl = document.getElementById('scoreVal');
        const timeEl = document.getElementById('timeVal');

        let width, height;
        let score = 0;
        let timeLeft = 30;
        let gameActive = false;
        let targets = [];
        let gameLoopId;
        let timerId;
        let currentMode = 'random';
        let frameCount = 0; // アニメーション用カウンタ

        // 画面サイズ設定
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        function startGame(mode) {
            currentMode = mode;
            menuScreen.style.display = 'none';
            resultScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            
            score = 0;
            timeLeft = 30;
            frameCount = 0;
            scoreEl.innerText = score;
            timeEl.innerText = timeLeft;
            gameActive = true;
            
            targets = [];
            // モード別初期化
            if (currentMode === 'random') {
                spawnTarget();
            } else if (currentMode === 'figure8') {
                // 8の字は最初に1個だけ作る（動かすのはupdateで）
                targets.push({ x: width/2, y: height/2, r: 30, color: '#00FF7F' });
            }

            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            update();
        }

        function backToMenu() {
            resultScreen.style.display = 'none';
            gameContainer.style.display = 'none';
            menuScreen.style.display = 'flex';
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerId);
            cancelAnimationFrame(gameLoopId);
            document.getElementById('result-msg').innerHTML = `Time Up!<br>Score: ${score}`;
            resultScreen.style.display = 'flex';
        }

        function spawnTarget() {
            const r = 25;
            const x = Math.random() * (width - r * 2) + r;
            const y = Math.random() * (height - r * 2) + r;
            const speed = 4;
            targets.push({
                x: x, y: y, r: r,
                vx: (Math.random() - 0.5) * speed * 2,
                vy: (Math.random() - 0.5) * speed * 2,
                color: '#00FF7F'
            });
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, width, height);
            frameCount++;

            // ■■■ 8の字モードの動き ■■■
            if (currentMode === 'figure8') {
                const t = targets[0]; // ターゲットは1つ
                const centerX = width / 2;
                const centerY = height / 2;
                // 画面幅の35%を半径に設定
                const radiusX = width * 0.35; 
                const radiusY = height * 0.2; // 縦は少し潰す
                const speed = 0.05; // 回転スピード

                // 8の字（レムニスケート曲線的な動き）
                // x = cos(t), y = sin(2t) / 2
                t.x = centerX + Math.cos(frameCount * speed) * radiusX;
                t.y = centerY + Math.sin(frameCount * speed * 2) * radiusY;
            }
            // ■■■ ランダムモードの動き ■■■
            else if (currentMode === 'random') {
                targets.forEach(t => {
                    t.x += t.vx;
                    t.y += t.vy;
                    if (t.x - t.r < 0 || t.x + t.r > width) t.vx *= -1;
                    if (t.y - t.r < 0 || t.y + t.r > height) t.vy *= -1;
                });
            }

            // 描画
            targets.forEach(t => {
                ctx.beginPath();
                ctx.arc(t.x, t.y, t.r, 0, Math.PI * 2);
                ctx.fillStyle = t.color;
                ctx.fill();
                ctx.closePath();
            });

            gameLoopId = requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive) return;
            e.preventDefault();
            const touches = e.changedTouches || [e]; 
            
            for (let i = 0; i < touches.length; i++) {
                const tx = touches[i].clientX;
                const ty = touches[i].clientY;

                for (let j = targets.length - 1; j >= 0; j--) {
                    const t = targets[j];
                    const dist = Math.hypot(t.x - tx, t.y - ty);
                    
                    if (dist < t.r + 20) { // 判定
                        score++;
                        scoreEl.innerText = score;

                        if (currentMode === 'random') {
                            targets.splice(j, 1);
                            spawnTarget();
                            if (score % 5 === 0) spawnTarget();
                        } else if (currentMode === 'figure8') {
                            // 8の字は消さずに、ヒットエフェクト（一瞬赤くなるなど）を入れたい所ですが
                            // まずはシンプルに点数だけ加算
                            // 連続タップ防止を入れるならここにフラグ処理
                        }
                        break;
                    }
                }
            }
        }

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput, {passive: false});

    </script>
</body>
</html>